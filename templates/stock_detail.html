{% extends "base.html" %}

{% block title %}{{ stock.symbol }} - {{ stock.name }} - Portfolio Manager{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">{{ stock.symbol }} - {{ stock.name }}</h1>
    <a href="{{ url_for('stocks') }}" class="btn btn-outline-secondary">
        <i class="fas fa-arrow-left"></i> Back to Stocks
    </a>
</div>

<!-- Stock Information Card -->
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <h3 class="text-primary">{{ stock.symbol }}</h3>
                        <p class="lead">{{ stock.name }}</p>
                        <!-- Affordability Status Badge -->
                        {% if account_balance >= stock.current_price %}
                            <span class="badge bg-success fs-6 mb-2">
                                <i class="fas fa-check-circle"></i> Can Buy
                            </span>
                            <br><small class="text-success">
                                You can afford up to {{ (account_balance // stock.current_price)|int }} shares
                            </small>
                        {% else %}
                            <span class="badge bg-danger fs-6 mb-2">
                                <i class="fas fa-times-circle"></i> Insufficient Funds
                            </span>
                            <br><small class="text-danger">
                                Need ${{ "%.2f"|format(stock.current_price - account_balance) }} more
                            </small>
                        {% endif %}
                    </div>
                    <div class="col-md-3">
                        <h5>Current Price</h5>
                        <h2 class="profit">${{ "%.2f"|format(stock.current_price) }}</h2>
                    </div>
                    <div class="col-md-3">
                        <h5>Total Holdings</h5>
                        <h2>{{ holdings|sum(attribute='quantity') or 0 }} shares</h2>
                    </div>
                    <div class="col-md-3">
                        <h5>Total Value</h5>
                        <h2 class="profit">${{ "%.2f"|format(holdings|sum(attribute='current_value') or 0) }}</h2>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Buy/Sell Forms -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card border-success">
            <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-plus-circle"></i> Buy {{ stock.symbol }}</h5>
                <!-- Real-time Affordability Badge -->
                {% if account_balance >= stock.current_price %}
                    <span class="badge bg-light text-success" id="affordability_badge">
                        <i class="fas fa-wallet"></i> Affordable
                    </span>
                {% else %}
                    <span class="badge bg-warning text-dark" id="affordability_badge">
                        <i class="fas fa-exclamation-triangle"></i> Insufficient Funds
                    </span>
                {% endif %}
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('buy_stock', symbol=stock.symbol) }}">
                    <div class="mb-3">
                        <label for="buy_portfolio" class="form-label">Portfolio</label>
                        <select class="form-select" id="buy_portfolio" name="portfolio_id" required>
                            <option value="">Select Portfolio</option>
                            {% for portfolio in portfolios %}
                            <option value="{{ portfolio.id }}">{{ portfolio.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="buy_quantity" class="form-label">Quantity</label>
                        <input type="number" class="form-control" id="buy_quantity" name="quantity" min="1" required>
                    </div>
                    <div class="mb-3">
                        <label for="buy_price" class="form-label">Price per Share ($)</label>
                        <input type="number" class="form-control" id="buy_price" name="price" 
                               step="0.01" min="0.01" value="{{ stock.current_price }}" required>
                        <div class="form-text">Current market price: ${{ "%.2f"|format(stock.current_price) }}</div>
                    </div>
                    <div class="mb-3">
                        <div class="bg-light p-2 rounded">
                            <strong>Total Cost: $<span id="buy_total">0.00</span></strong>
                            <br><small class="text-muted">Available Balance: ${{ "%.2f"|format(account_balance) }}</small>
                        </div>
                    </div>
                    <div class="mb-3" id="balance_warning" style="display: none;">
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle"></i> Insufficient balance for this purchase!
                        </div>
                    </div>
                    <button type="submit" class="btn btn-success w-100" id="buy_button">
                        <i class="fas fa-shopping-cart"></i> Buy Shares
                    </button>
                </form>
            </div>
        </div>
    </div>

    <div class="col-md-6">
        <div class="card border-danger">
            <div class="card-header bg-danger text-white">
                <h5 class="mb-0"><i class="fas fa-minus-circle"></i> Sell {{ stock.symbol }}</h5>
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('sell_stock', symbol=stock.symbol) }}">
                    <div class="mb-3">
                        <label for="sell_portfolio" class="form-label">Portfolio</label>
                        <select class="form-select" id="sell_portfolio" name="portfolio_id" required>
                            <option value="">Select Portfolio</option>
                            {% for holding in holdings %}
                            <option value="{{ holding.portfolio_id }}" data-max-shares="{{ holding.quantity }}">
                                {{ holding.portfolio_name }} ({{ holding.quantity }} shares)
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="sell_quantity" class="form-label">Quantity</label>
                        <input type="number" class="form-control" id="sell_quantity" name="quantity" min="1" required>
                        <div class="form-text">Available shares: <span id="available_shares">0</span></div>
                    </div>
                    <div class="mb-3">
                        <label for="sell_price" class="form-label">Price per Share ($)</label>
                        <input type="number" class="form-control" id="sell_price" name="price" 
                               step="0.01" min="0.01" value="{{ stock.current_price }}" required>
                        <div class="form-text">Current market price: ${{ "%.2f"|format(stock.current_price) }}</div>
                    </div>
                    <div class="mb-3">
                        <div class="bg-light p-2 rounded">
                            <strong>Total Proceeds: $<span id="sell_total">0.00</span></strong>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-danger w-100">
                        <i class="fas fa-hand-holding-usd"></i> Sell Shares
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Current Holdings -->
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Current Holdings</h5>
            </div>
            <div class="card-body">
                {% if holdings %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Portfolio</th>
                                <th>Quantity</th>
                                <th>Avg Buy Price</th>
                                <th>Current Value</th>
                                <th>P&L</th>
                                <th>P&L %</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for holding in holdings %}
                            <tr>
                                <td>
                                    <a href="{{ url_for('portfolio_detail', portfolio_id=holding.portfolio_id) }}" 
                                       class="text-decoration-none">
                                        {{ holding.portfolio_name }}
                                    </a>
                                </td>
                                <td>{{ holding.quantity }}</td>
                                <td>${{ "%.2f"|format(holding.avg_buy_price) }}</td>
                                <td class="profit">${{ "%.2f"|format(holding.current_value) }}</td>
                                <td class="{% if holding.profit_loss >= 0 %}profit{% else %}loss{% endif %}">
                                    ${{ "%.2f"|format(holding.profit_loss) }}
                                </td>
                                <td class="{% if holding.profit_loss >= 0 %}profit{% else %}loss{% endif %}">
                                    {% if holding.avg_buy_price > 0 %}
                                        {{ "%.2f"|format(((stock.current_price - holding.avg_buy_price) / holding.avg_buy_price) * 100) }}%
                                    {% else %}
                                        N/A
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="text-muted">No current holdings for this stock.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Recent Transactions -->
<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Recent Transactions</h5>
            </div>
            <div class="card-body">
                {% if transactions %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Type</th>
                                <th>Portfolio</th>
                                <th>Quantity</th>
                                <th>Price</th>
                                <th>Total</th>
                                <th>Date</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for transaction in transactions %}
                            <tr>
                                <td>
                                    <span class="badge {% if transaction.type == 'BUY' %}bg-success{% else %}bg-danger{% endif %}">
                                        {{ transaction.type }}
                                    </span>
                                </td>
                                <td>{{ transaction.portfolio_name }}</td>
                                <td>{{ transaction.quantity }}</td>
                                <td>${{ "%.2f"|format(transaction.price) }}</td>
                                <td class="{% if transaction.type == 'BUY' %}text-danger{% else %}profit{% endif %}">
                                    ${{ "%.2f"|format(transaction.quantity * transaction.price) }}
                                </td>
                                <td>{{ transaction.timestamp[:19] }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="text-muted">No transactions found for this stock.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Calculate and display buy total with balance validation
function updateBuyTotal() {
    const quantity = document.getElementById('buy_quantity').value || 0;
    const price = document.getElementById('buy_price').value || 0;
    const total = (parseFloat(quantity) * parseFloat(price)).toFixed(2);
    document.getElementById('buy_total').textContent = total;
    
    // Check if total exceeds available balance
    const availableBalance = parseFloat('{{ account_balance }}');
    const buyButton = document.getElementById('buy_button');
    const balanceWarning = document.getElementById('balance_warning');
    const affordabilityBadge = document.getElementById('affordability_badge');
    
    if (parseFloat(total) > availableBalance) {
        balanceWarning.style.display = 'block';
        buyButton.disabled = true;
        buyButton.classList.remove('btn-success');
        buyButton.classList.add('btn-secondary');
        
        // Update affordability badge
        affordabilityBadge.className = 'badge bg-danger text-white';
        affordabilityBadge.innerHTML = '<i class="fas fa-times-circle"></i> Cannot Afford';
    } else {
        balanceWarning.style.display = 'none';
        buyButton.disabled = false;
        buyButton.classList.remove('btn-secondary');
        buyButton.classList.add('btn-success');
        
        // Update affordability badge
        if (parseFloat(total) > 0) {
            affordabilityBadge.className = 'badge bg-success text-white';
            affordabilityBadge.innerHTML = '<i class="fas fa-check-circle"></i> Can Afford';
        } else {
            affordabilityBadge.className = 'badge bg-light text-success';
            affordabilityBadge.innerHTML = '<i class="fas fa-wallet"></i> Affordable';
        }
    }
}

// Calculate total proceeds for selling
function updateSellTotal() {
    const quantity = document.getElementById('sell_quantity').value || 0;
    const price = document.getElementById('sell_price').value || 0;
    const total = (parseFloat(quantity) * parseFloat(price)).toFixed(2);
    document.getElementById('sell_total').textContent = total;
}

// Update available shares when portfolio is selected
function updateAvailableShares() {
    const select = document.getElementById('sell_portfolio');
    const selectedOption = select.options[select.selectedIndex];
    const maxShares = selectedOption.getAttribute('data-max-shares') || 0;
    document.getElementById('available_shares').textContent = maxShares;
    
    const quantityInput = document.getElementById('sell_quantity');
    quantityInput.max = maxShares;
    quantityInput.value = '';
}

// Event listeners
document.getElementById('buy_quantity').addEventListener('input', updateBuyTotal);
document.getElementById('buy_price').addEventListener('input', updateBuyTotal);
document.getElementById('sell_quantity').addEventListener('input', updateSellTotal);
document.getElementById('sell_price').addEventListener('input', updateSellTotal);
document.getElementById('sell_portfolio').addEventListener('change', updateAvailableShares);

// Form validation
document.querySelector('form[action*="sell"]').addEventListener('submit', function(e) {
    const quantity = parseInt(document.getElementById('sell_quantity').value);
    const maxShares = parseInt(document.getElementById('available_shares').textContent);
    
    if (quantity > maxShares) {
        e.preventDefault();
        alert(`Cannot sell ${quantity} shares. You only have ${maxShares} shares available.`);
    }
});
</script>
{% endblock %}
